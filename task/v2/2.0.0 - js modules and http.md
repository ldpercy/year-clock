JS Modules and HTTP
===================

Convert to JS modules and http-only

```
2025-11-20		Start ðŸ„¹Â§
2025-11-24		v2.0.0 Done (after re-versioning previous release)
```

The conversion to js modules for Turtle was fairly painless.

I'm not expecting it to be so easy here:
* Older, more complex, messier code
* Theme code is currently dynamically loaded - I know this can be done with modules, but *promises* (shiver)
* More code to deal with overall



Initial thoughts
----------------

It's kinda lame, but I'm inclned to just run at this one like a bull at gate, get something working, and think about it after.
Promises are still a bad tasting medicine for me.



### First problem - namespaces

So here's a problem i didn't have in Turtle.

Up till now I've made use of classes for namespacing, and for that job they're "not too bad".

I'd collected my classes under two main namespaces 'yearclock' and 'ldpercy', so for instance I have an extension of js Date called 'yearclock.Date'.

In js modules though i'm not sure if/how I should do the same thing.



Starting off
------------

Running around adding exports and imports and updating things.
It's very messy and makes me a bit queasy.

Run into my first hard stopper - I think I have a circular import dependency of some sort:
FF:
> Uncaught ReferenceError: can't access lexical declaration 'Date' before initialization
Ch:
> YearClock.js:114 Uncaught ReferenceError: Failed to read the 'Date' property from 'Module': Cannot access 'Date' before initialization
    at YearClock.js:114:48

Not sure how to track it down just yet.

https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules#cyclic_imports


I've run ahead a little, but I solved the cyclic import by moving some of the date-related stuff that was sitting in YearClock.js into the Dates module.
The code at this point is still incredibly messy - I *really* hope I can start to get it a lot cleaner after all this.

I have one theme working now, working on getting all the others updated.
A few modules have been renamed into things that seem more sensible for now, but this is very much wip - it will take time for things to settle down into what makes sense in the new module world.


It occurs to me while doing all this that several of the modules are reverting back to pretty much to what they looked like before the class conversion.
Oh well, these things happen.



Status mini report
------------------

* All themes are working now, and all features seem okay, will take some time to play with and make sure
* I've not been especially particular about how i've done exports, will review in time, there will be improvements to be made there

I've used a dynamic import in yearClockApp to get the theme classes each time.
This pretty much mimics how it was done previously, but in module parlance.
I'm not really sure yet if there will be better ways of doing this now - for instance should I cache or retain the theme module bindings similar to what I was dfoing before?
It's all working okay now, so will review in time I guess.


One notable thing that is being sorted out for me in the new scheme is the callback in the theme loading.
Dynamic module loads look like this now:

	const themeModule = await import(themeModuleUrl);

And the callback sequence that I had for ages goes away, which is nice.
I'll need to do a bit more testing around it though as not sure yet what handling I need for failed/missing responses.


A lot of code looks 'sort of' cleaner under this system too.
I'm mainly meaning that the binding names created by the imports are generally shorter than the old canonical namespacing I was using with classes.
So it's a win in that sense, but I'm finding myself wondering if there *are* ways to create canonical namespaces with modules.
For example i had been using things like:

	yearclock.Date
	yearclock.DisplayDate
	yearclock.Geometry.AngularRange

Which read nicely sometimes, instead of just the module aliases of:

	dates.Date
	dates.DisplayDate
	geometry.AngularRange

Pros and cons though - I think in setups like node there are canonical names, but might be environment/packaging dependent; will look around for a refresher.



Error handling is also something that needs work; there's a pattern I've seen described as something like 'railroad' with happy and error paths, need to look up.


A couple of themes are still a bit slow:
* firefox: vintage
* chromium: lightning
Will need to revisit the redraw performance again sometime.


At this point I'm inclined to release, as everything is running green and working afaict.
Anything else, polish & improvements etc, can come in later jobs.



Re-version this as 2.0; drop class-ification back
--------------------------------------------------
I've decided I'm going to try to re-version this release as 2.0 as it represents a more significant overall change than the previous class-ification release.

I'm going to try to push that back to the v1 series.
I know I don't have *have* to do this but I want to, partly to keep the versioning meaningful, and partly just to see if I can.

If this works the major versions will represent these phases:

	v0: script era
	v1: class era
	v2: module era

Don't know yet how tricky this will be, *hopefully* it will just mean removing the old tags and retagging it with the updated version numbers.

I'll jump back to main and have a crack.
It's tempting to try to go back in time and also update the internal version numbers stored on the old commits, but that will probably be way too messy, and also not very kosher.
I'll try just adding a new update commit to the head of main, and update the old tags.

### Back from main

These were all retagged as v1.12

	v2.0.0	-> v1.12.0	f602abf0d0e564f30594bc763a49d5bdcf8e904b		Class-ification
	v2.0.1	-> v1.12.1	2127cea7c1cfa6418d024df95ddbde9ad97d8802		Class-ification followup 1
	v2.0.2	-> v1.12.2	4fccaf27761f63e1ea6dda88228e47b11b7cc526		Class-ification followup 2


	git tag -s "v1.12.0" f602abf0d0e564f30594bc763a49d5bdcf8e904b -m "Class-ification"
	git tag -s "v1.12.1" 2127cea7c1cfa6418d024df95ddbde9ad97d8802 -m "Class-ification followup 1"
	git tag -s "v1.12.2" -m "Class-ification followup 2"

The last tag was done on the new head of main on the version update commit (9bd39c76).


I've removed the old tags from local and remotes.
I've updated the previous release on github as well, looks okay, okay enough at least.


Wrapup
======



* Updates for test page to work under http
* Add warning if loaded with `file:`
* Converted all the library and theme js files to modules
* Hit a cyclic dependency issue, but it was in v.ugly code, putting the mess back together 'solved' it
* Some of the files that were only recently converted to classes have gone back to being function libraries now (which is fine, they're better off like this as modules)
* index.html now only loads a single module script `<script type="module" src="yearclock/yearClockApp.js"></script>`
* The old theme loading callback has been replaced with an async module load for the theme code
* Various cleanups; updates to doco+wiki
* Re-versioned the previous class-ification release back to the 1.x series






Future work:


* Themes extending 'ThemeBase' could perhaps be done away with. I'd considered a change like this during the class conversion, but held off. With modules I'm more likely to make this change now.
* Found an unusual bug at the last minute, will return to in a dot release -> [october bug](<october bug.md>)

