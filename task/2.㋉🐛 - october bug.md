October bug
===========


Probably a counting/off-by-one error of some sort.

```
2025-11-24		Open	„ãâüêõ
2025-11-25		Start work
```

Only just noticed this, am still investigating.
Appears to be an error in month-day angle calculation putting the hands in wrong spot, but seemingly only in October???

*	index.html?test=true&theme=vintage&date=2006-10-13


Affected that I can see easily:
* vintage
* car-dashboard
* wall-clock

Wheel, solar and space are probably similarly affected, but a little harder to spot on those.



Start work
----------

This is getting weirder and weirder.
Some years or year ranges seem affected, other not.
Checking using `&date=1970-10-15&theme=vintage`.

These look correct:

	1900-1970 *except* 1943
	2000

These show the bug:

	1943
	1971-1999
	2001 onwards, up until at least 2200, haven't gone further


Testing
-------

I'll probably end up finding the error first, but I really need to work on some test suites.
In this case being able to quickly run through a sequence of dates and see certain results as text would be ideal.
At the moment smoke testing is the only and default test; I'll start adding some more options.

I've added a little 'October' test to verify what I'm seeeing.

The discrepancy lies in the difference between:

	displayDate.daysInMonth				// this is correct
	displayDate.monthRange.length		// this is incorrect for the ranges outlined above


So `monthRange.length` is wrong sometimes for some reason, and so far only in October.

It defers its calc to `dayDifference`.


dayDifference & daylight savings
--------------------------------

```js
	return Math.floor((truncateTime(date2) - truncateTime(date1)) / (1000 * 60 * 60 * 24));
```

This is probably a line of code i snarfed from SO, so yeah blames on me.


It's looking like it might be related to daylight savings.
Most of the 'good' Octobers have their ends as:

 	end: Date Sun Nov 01 1970 00:00:00 GMT+1000 (Australian Eastern Standard Time)

Whereas the 'bad' Octobers have:

	end: Date Mon Nov 01 1971 00:00:00 GMT+1100 (Australian Eastern Daylight Time)

This is the general rule, though there appear to be one or two exceptions.

* 1971 must have been when daylight savings was introduced into eastern Australia
* 2000 might have been a special change for the Sydney Olympics - the bug is in August of that year
* 1943 could be war related?

So there's probably a corresponding April bug as well.


### April bug

Can't find any. The maths must be kinder to that changeover.

The October bug itself has likely existed for some time.


Remedies & Temporal
-------------------

There are probably a few short-term remedies that could be put in place to quickly fix it:
* tweak the dayDifference function arithmetic
* see if there's an easy way to change monthRange to use daysInMonth
* use dayOfYear maths instead

Going to have a squizz over at Temporal to see what's coming in there.
It definitely looks like there are methods in there that will handle these sort of problems, and in much more rigorous ways, so no question it's the way to go.
And the changeover is on my shortlist of upcoming tasks.
However it doesn't look like it's necessarily going to be a quick or easy change, I might have introduce it in small pieces.

For now going to try changing the maths.
The `dayDifference` function is actually currently relied upon by `dayOfYear` so I can't change that alone.
The temporary fix for today will be to change the 'floor' to a 'round', so in cases where it's bit marginal like an hours difference for daylight savings we'll use the *nearest* whole number instead.
Far from perfect, but workable for now.


