JS Modules and HTTP
===================

Convert to JS modules and http-only

```
2025-11-20		Start ðŸ„¹Â§
```

The conversion to js modules for Turtle was fairly painless.

I'm not expecting it to be so easy here:
* Older, more complex, messier code
* Theme code is currently dynamically loaded - I know this can be done with modules, but *promises* (shiver)
* More code to deal with overall



Initial thoughts
----------------

It's kinda lame, but I'm inclned to just run at this one like a bull at gate, get something working, and think about it after.
Promises are still a bad tasting medicine for me.



### First problem - namespaces

So here's a problem i didn't have in Turtle.

Up till now I've made use of classes for namespacing, and for that job they're "not too bad".

I'd collected my classes under two main namespaces 'yearclock' and 'ldpercy', so for instance I have an extension of js Date called 'yearclock.Date'.

In js modules though i'm not sure if/how I should do the same thing.



Starting off
------------

Running around adding exports and imports and updating things.
It's very messy and makes me a bit queasy.

Run into my first hard stopper - I think I have a circular import dependency of some sort:
FF:
> Uncaught ReferenceError: can't access lexical declaration 'Date' before initialization
Ch:
> YearClock.js:114 Uncaught ReferenceError: Failed to read the 'Date' property from 'Module': Cannot access 'Date' before initialization
    at YearClock.js:114:48

Not sure how to track it down just yet.

https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules#cyclic_imports


I've run ahead a little, but I solved the cyclic import by moving some of the date-related stuff that was sitting in YearClock.js into the Dates module.
The code at this point is still incredibly messy - I *really* hope I can start to get it a lot cleaner after all this.

I have one theme working now, working on getting all the others updated.
A few modules have been renamed into things that seem more sensible for now, but this is very much wip - it will take time for things to settle down into what makes sense in the new module world.


It occurs to me while doing all this that several of the modules are reverting back to pretty much to what they looked like before the class conversion.
Oh well, these things happen.



Status mini report
------------------

* All themes are working now, and all features seem okay, will take some time to play with and make sure
* I've not been especially particular about how i've done exports, will review in time, there will be improvements to be made there

I've used a dynamic import in yearClockApp to get the theme classes each time.
This pretty much mimics how it was done previously, but in module parlance.
I'm not really sure yet if there will be better ways of doing this now - for instance should I cache or retain the theme module bindings similar to what I was dfoing before?
It's all working okay now, so will review in time I guess.


One notable thing that is being sorted out for me in the new scheme is the callback in the theme loading.
Dynamic module loads look like this now:

	const themeModule = await import(themeModuleUrl);

And the callback sequence that I had for ages goes away, which is nice.
I'll need to do a bit more testing around it though as not sure yet what handling I need for failed/missing responses.


A lot of code looks 'sort of' cleaner under this system too.
I'm mainly meaning that the binding names created by the imports are generally shorter than the old canonical namespacing I was using with classes.
So it's a win in that sense, but I'm finding myself wondering if there *are* ways to create canonical namespaces with modules.
For example i had been using things like:

	yearclock.Date
	yearclock.DisplayDate
	yearclock.Geometry.AngularRange

Which read nicely sometimes, instead of just the module aliases of:

	dates.Date
	dates.DisplayDate
	geometry.AngularRange

Pros and cons though - I think in setups like node there are canonical names, but might be environment/packaging dependent; will look around for a refresher.




